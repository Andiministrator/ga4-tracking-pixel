___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "CLIENT",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "GA4 Tracking Pixel",
  "categories": [
    "ANALYTICS",
    "MARKETING",
    "TAG_MANAGEMENT"
  ],
  "brand": {
    "id": "andiministrator",
    "displayName": "Andiministrator",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "A Tracking Pixel for sending a configurable Event to GA4 (serverside) and returns a GIF Pixel.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pixel_name",
    "displayName": "Name of Image",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "defaultValue": "gatp.gif"
  },
  {
    "type": "GROUP",
    "name": "ga4_measurement_ids",
    "displayName": "Setup of IDs (in URL path) and GA4 Measurement IDs",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "ids",
        "displayName": "Allowed IDs and GA4 Measure IDs",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "id",
              "displayName": "The ID for the URL Path",
              "simpleValueType": true,
              "help": "This is the ID for the URL Path. E.g. if you set here \"\u003cstrong\u003exyz123\u003c/strong\u003e\", the Pixel Request URL has to be:\u003cbr /\u003e \nhttps://hostofyour.serverside-gtm.com/\u003cstrong\u003exyz123\u003c/strong\u003e/gatp.gif",
              "valueHint": "xyz123",
              "valueValidators": [
                {
                  "type": "NON_EMPTY"
                }
              ]
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "TEXT",
              "name": "ga4id",
              "displayName": "GA4 Measurement ID to track the Event",
              "simpleValueType": true,
              "valueHint": "G-1234567",
              "valueValidators": [
                {
                  "type": "NON_EMPTY"
                }
              ]
            },
            "isUnique": true
          }
        ],
        "help": "Set allowed IDs to track an event to the connected GA4 Measurement ID.\u003cbr /\u003e You can use any string containing letters, numbers or the characters \"_\" and \"-\".",
        "newRowButtonText": "New ID"
      },
      {
        "type": "TEXT",
        "name": "default_id",
        "displayName": "Default GA4 Measurement ID",
        "simpleValueType": true,
        "help": "Use a GA4 Default Measurement ID if no other configured ID matches.\u003cbr /\u003e If you leave it blank, no event will be tracked if no configured ID matches and the Pixel will return a 404 Error (instead of a GIF Pixel).",
        "valueHint": "G-1234567"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "event_settings",
    "displayName": "Event Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "eventname",
        "displayName": "Event Name",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "pixel_view"
      },
      {
        "type": "PARAM_TABLE",
        "name": "attributes",
        "displayName": "(URL-)Path/Attribute Mapping",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "attribute",
              "displayName": "Name of the Attribute",
              "simpleValueType": true
            },
            "isUnique": true
          }
        ],
        "help": "You can pass multiple values for attributes in the URL path, between the ID and the image name, e.g.:\u003cbr /\u003e https://yourdomain.com/id-placeholder/\u003cstrong\u003eattribute-1-value\u003c/strong\u003e/\u003cstrong\u003eattribute-2-value\u003c/strong\u003e/image.gif\u003cbr /\u003e In this order, you can specify the names the attributes should have for transfer to Google Analytics.\u003cbr /\u003e\nIf no name is specified for an attribute, it is passed as attribute1 (for the first attribute)."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "additional_attributes",
        "displayName": "Event Attributes",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "attribute_name",
            "type": "TEXT",
            "valueHint": "",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "attribute_value",
            "type": "TEXT",
            "selectItems": [
              {
                "value": true,
                "displayValue": "Yes"
              },
              {
                "value": false,
                "displayValue": "No"
              }
            ],
            "valueValidators": []
          }
        ],
        "newRowButtonText": "New Attribute"
      },
      {
        "type": "TEXT",
        "name": "hostname",
        "displayName": "Hostname for Google Analytics",
        "simpleValueType": true,
        "defaultValue": "example.com"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "image",
    "displayName": "Image Options",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "SELECT",
        "name": "image_format",
        "displayName": "Image Format",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "gif",
            "displayValue": "GIF"
          },
          {
            "value": "png",
            "displayValue": "PNG"
          },
          {
            "value": "jpeg",
            "displayValue": "JPEG"
          }
        ],
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "image_content",
        "displayName": "Image Content as Base64",
        "simpleValueType": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// ssGTM Doku: https://developers.google.com/tag-platform/tag-manager/server-side/api?hl=de
// aGTM Doku: https://github.com/Andiministrator/ga4-tracking-pixel
const ga4TPversion = "1.0";

// Load Libraries
const log = require('logToConsole');
const claimRequest = require('claimRequest');
//const sendHttpRequest = require('sendHttpRequest');
const setResponseStatus = require('setResponseStatus');
const setResponseHeader = require('setResponseHeader');
const setResponseBody = require('setResponseBody');
const sendEventToGoogleAnalytics = require('sendEventToGoogleAnalytics');
//const setPixelResponse = require('setPixelResponse');
const returnResponse = require('returnResponse');
const getRequestPath = require('getRequestPath');
const getRequestHeader = require('getRequestHeader');
//const getRequestQueryParameters = require('getRequestQueryParameters');
//onst Promise = require('Promise');
const runContainer = require('runContainer');
const createRegex = require('createRegex');
const testRegex = require('testRegex');
const generateRandom = require('generateRandom');
const getTimestampMillis = require('getTimestampMillis');
//const fromBase64 = require('fromBase64');
const makeString = require('makeString');
//const JSON = require('JSON');
var err = '';

// Check Path (and Pixel Name for ID
var pixelname = data.pixel_name;
var path = getRequestPath();
var regex = createRegex('^/[a-zA-Z0-9_-]+/[a-zäöüßA-ZÄÖÜ0-9\\/\\s\\+\\._-]*/?'+pixelname+'$','');
if (!testRegex(regex, path)) return;
var parts = path.split('/');
if (parts.length < 3) return;
var id = parts[1];
if (typeof id !== 'string' || !id) return;
var p = parts.length>3 ? parts.slice(2, -1) : [];

// Check whether ID is matching and set GA4 ID
var ids = data.ids || [];
var ga4id = data.default_id || '';
for (var i=0; i<ids.length; i++) {
  if (ids[i].id==id) {
    ga4id = ids[i].ga4id;
    break;
  }
}
if (!ga4id) return;

// Claim Request
claimRequest();

// Build GA4 Event
var event = { event_name: data.eventname };

// Add Necessary Event Data
event['x-ga-protocol_version'] = '2';
event['x-ga-measurement_id'] = ga4id; // e.g. 'G-3105KCF4NC';
//event['x-ga-client_id'] = '799925220.1727100378';
//event['x-ga-temp_client_id'] = '997570488';
//event['x-ga-lps'] = true;
event['x-ga-request_count'] = 1;
event['x-ga-gcs'] = 'G101';
event['x-ga-gcd'] = '13p3t3p3p5l1';
event['x-ga-npa'] = '0';
event['x-ga-dma'] = true;
event['x-ga-dma_cps'] = '-';
event['x-ga-country'] = 'DE';
event['x-ga-region'] = 'DE';
event['x-gclb-country'] = 'DE';
event['x-gclb-region'] = 'DE';
// Add Common Event Data
event.client_id = makeString(getTimestampMillis()) + '.' + makeString(generateRandom(1, 10000000));
event.ip_override = '49.156.48.123';
event.language = 'de-de';
event.page_encoding = 'UTF-8';
event.page_hostname = data.hostname || 'example.com';
event.page_location = 'https://'+event.page_hostname+path;
event.page_path = path;
//event.page_title = 'Newsletter 1';
//event.page_referrer = 'test.com';
event.user_agent = getRequestHeader('user-agent');
if (!event.user_agent) event.user_agent = 'Andiministrator;1.0|Fake%20Browser;1.0|Not.A%2FBrand;99.0.0.0';
event.screen_resolution = '1024 x 768';
event.viewport_size = '1000 x 750';

// Add overhanded (path) attributes
var pathnames = data.attributes || [];
var regex = createRegex('[^a-zäöüßA-ZÄÖÜ0-9\\s\\+\\._-]','g');
for (var i=0; i<p.length; i++) {
  var attr_name = 'attribute' + makeString(i+1);
  if (typeof pathnames[i]=='object' && typeof pathnames[i].attribute=='string' && pathnames[i].attribute) {
    attr_name = pathnames[i].attribute;
  }
  event[attr_name] = p[i].replace(regex, '');
}

// Add userdefined attributes
var attr = data.additional_attributes || [];
for (var i=0; i<attr.length; i++) {
  event[attr[i].attribute_name] = attr[i].attribute_value;
}

// Prepare Image Response
var img_format = data.image_format || 'gif';
img_format = img_format.trim();
var img_content = data.image_content || '';
img_content = img_content.trim();
if (!img_content) {
  img_format = 'gif';
  img_content = 'R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
}

// Sends the event to Google Analytics
/*sendEventToGoogleAnalytics(event).then((response) => {
  if (response.location) {
    //setResponseHeader('location', response.location);
    //setResponseStatus(302);
  } else {
    //setResponseStatus(200);
  }
}).catch((error) => {
  err = 'Error sending Event to Google Analytics: ' + error.reason;
  //setResponseStatus(500);
});*/


// Send Response
runContainer(event, function() {
  // OnComplete
  returnResponse();
}, function() {
  // OnStart
  setResponseHeader('Content-Type', 'image/'+img_format);
  setResponseHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');
  setResponseHeader('Pragma', 'no-cache');
  setResponseHeader('Expires', '0');
  setResponseStatus(200);
  setResponseBody(img_content, 'base64');
});


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "return_response",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "run_container",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Check JS Code
  code: |
    // Set Mocks
    //mock('setResponseStatus', 200);
    //mock('setResponseHeader', '1.2.2');
    //mock('setResponseBody', 'console.log("aGTM");');
    //mock('returnResponse');

    // Run Code
    runCode(mockData);

    // Checks
    //assertApi('setResponseStatus').wasCalledWith(200);
    //assertApi('setResponseHeader').wasCalled();
    //assertApi('setResponseBody').wasCalled();
    //assertApi('returnResponse').wasCalled();
setup: |-
  // Import needed libraries
  const log = require('logToConsole');

  // Set Mocks
  mock('getRequestPath','/id123/ab12/cd34/ef56/gatp.gif');

  // Setup MockData
  const mockData = {
    eventname: 'pixel_view',
    pixel_name: 'gatp.gif',
    ids: [ {id:'id1',ga4id:'G-12345'}, {id:'id2',ga4id:'G-67890'} ],
    default_id: 'G-123',
    attributes: [ {attribute:'attribute_name_1'}, {attribute:'attribute_name_2'} ],
    additional_attributes: [ {attribute_name:'add_attribute_name_1', attribute_value:'add_attribute_value_1'} ]
  };


___NOTES___

# Serverside GTM Client Template for a GA4 Tracking Pixel

A Tracking Pixel for sending a configurable Event to GA4 (serverside) and returns a GIF Pixel..


